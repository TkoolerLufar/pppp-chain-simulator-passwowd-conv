れんしゅうノート パスワードコンバーター
====

目標
----

「ぷよぷよ！！」と「ぷよぷよパズルポップ」のれんしゅうノートで組んだ連鎖の
パスワードを変換するWebページを作る。

1. ぷよ7/ぷよ！！&rarr;ぷよポップ
2. ぷよポップ&rarr;ぷよ！！/ぷよ7

パスワードの仕様
----

### 共通

#### パスワードの内容

パスワードに保存するものと文字数は以下の順

1. フィールドの中身（ルールとフォーマットで文字数が変わる）
2. パスワード自体のフォーマット（1文字）

パスワードに直接記載はされないが内容から推測するのは、ルール。
（ぷよ何個分のデータが入ってるかで判定する）

保存を諦めているのは、キャラクターの指定と、フィーバー有無。

#### 1文字あたりの情報量

64種類の文字を使う。
1文字あたり6bit。
ここから先は「パスワード1文字分の情報6bit」を指して
**sextet (セクステット)** と呼ぶことにする。

#### フォーマット

プレーンとRLEの2種類。

パスワードの末尾が 000 (「あ」 "A") ならプレーン、
002 (「う」"C") ならRLE

#### ぷよを表す順番

英語など横書きの文章と似た要領。

まずは最上段のぷよを左から順にエンコードし、
端まで来たら次はその下の段のぷよをエンコードする。
これを最下段まで繰り返す。

例えばフィールドの左端の座標を (x, y) = (1, 1) としたら、
1文字目は (1, 1) と (2, 1) にあるぷよをエンコードする。
3文字目が (5, 1), (6, 1) をエンコードした後、
4文字目は改行して (1, 2), (2, 2) をエンコードする。

でかぷよフィールドでは幅が奇数なので、
例えば2文字目が (3, 1) と (1, 2) をエンコードするようになる。
面積も奇数なので情報量が3bit余ってしまうが、
この時は画面外にもう1マス空白が存在していることにする。

(例) でかぷよフィールドで全面赤のパスワード: `11 11 01 00 02`
(`ここいあ う` / `KKBAC`)

#### 1セクステットが表現する2ぷよの情報

下位3bitが1マス目、上位3bitが2マス目の内容を表す。
（リトルエンディアン）

3bit|ぷよ
---:|:--:
0|空きマス
1|赤ぷよ
2|緑ぷよ
3|青ぷよ
4|黄ぷよ
5|紫ぷよ
6|おじゃまぷよ
7|太陽ぷよ

#### RLEについて

RLEの場合、先頭のセクステットが2マス分の内容を表し、
次のセクステットがその (繰り返し回数-1）の値になる。
例えば6回繰り返すなら 005 、64回繰り返すなら 077 という具合。
これで、同じセクステットの繰り返し1〜64回を2セクステットに圧縮する。

#### フォーマットの選択

パスワードを作るときにプレーンとRLEのどちらになるかだが、
**実際に両方のフォーマットでパスワードを作り短い方をプレイヤーに見せる。**

1. まずはプレーンパスワードを生成する。
2. プレーンパスワードをRLEしながら文字数を測る。
3. 途中でRLEのパスワード長がプレーンを超えてしまったら、
   RLEパスワードを破棄してプレーンパスワードを採用する。
4. 最後までRLEパスワードができたらそれを採用する。

### 相違点

#### 使う文字

##### ぷよ7、ぷよ！！

000 から昇順に

```
あいうえおかきく
けこさしすせそた
ちつてとなにのは
ひふへほまみむも
やゆよらりるろを
ＡＢＣＤＥＦＧＨ
ＩＪＫＬＭＮＰＲ
ＳＴＵＶＷＸＹＺ
```

##### ぷよポップ

000 から昇順に

```
ABCDEFGH
JKLMNPQR
STUVWXYZ
adefghij
mnrty012
3456789!
#$%&*+-/
=<>?@\^~
```

#### 太陽ぷよの扱いについて

ぷよ7はぷよぷよSUNルールと太陽ぷよに対応していない。
ぷよ！！とぷよ7で互換性のあるパスワードはこれ以外に限られる。

#### RLEで65セクステット以上の連続を圧縮する時の挙動

ちびぷよのRLEで連続回数が64を超える場合は2セクステットに収まらない。
こう言う時は同じセクステットの繰り返しを2セット書くのだが、
繰り返し回数の配分がぷよ7&amp;ぷよ！！とぷよポップで異なる。

ぷよ7、ぷよ！！では、1セット目の繰り返しを限界の64回行い、
2セット目に残りの回数分繰り返す。

```
あＺああ こみう
```

ぷよポップでは繰り返し回数を2等分する。端数は2セット目に振り分けられる。

```
AjAmKhC
```

ぷよ7は前者のルールに則ったパスワードしか受け付けてくれないが、
ぷよ！！・ぷよポップで読むときはどちらでも良い。

#### でかぷよフィールドの右下1マスをRLEするときの挙動

ぷよポップででかぷよルールの右下1マスをRLEでエンコードする場合、
なぜか**強制的に前のシーケンスから切り離される。**

例えばまっさらなフィールドのエンコード結果は以下のようになる。

- ぷよ！！: `あさう` (`00 13 02`)
- ぷよポップ: `AKAA C` (`00 12 00 00 02`)

また、ぷよポップ ver. 1.3.0 では、
でかぷよルールで特定の条件に一致するフィールドをRLEすると**誤ったパスワードを生成するバグ**がある。

下記のイメージで以下の条件を全て満たすフィールドが該当する。

- 2つの💛が同じぷよ（または、共に空きマス）
- 🈳が空きマス
- 🔴が💛と異なるか、または🟩が空きマス以外になっている

```
❔❔❔
❔❌❔
❔❔❔
❔❔❔
❔❔❔
❔🔴🟩
💛🈳💛
```

この時生成されたパスワードの最後の2文字が `AC` になるが、正しくは `BC` である。

参考文献
--------

明日使えないムダ知識/パスワードの法則 - ぷよぷよ！！20th anniversary @2ch wiki - atwiki（アットウィキ） (2024年7月6日閲覧) https://w.atwiki.jp/puyo20th/pages/153.html
